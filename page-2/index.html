<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Jussi Judin's weblog</title><meta name="description" content="Programming related topics. Maybe even some original content!
"/><link rel="stylesheet" href="/css/main.css"/><link rel="canonical" href="https://barro.github.io/page-2/"/><link rel="alternate" type="application/rss+xml" title="Jussi Judin's weblog" href="https://feeds.feedburner.com/jussijudin"/><link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png"/><link rel="icon" type="image/png" href="/icons/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/icons/android-chrome-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/icons/favicon-96x96.png" sizes="96x96"/><link rel="icon" type="image/png" href="/icons/favicon-16x16.png" sizes="16x16"/><link rel="manifest" href="/icons/manifest.json"/><link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#00a300"/><meta name="msapplication-TileImage" content="/icons/mstile-144x144.png"/><meta name="theme-color" content="#ffffff"/><meta content="928229747232422" property="fb:app_id"/><meta content="Jussi Judin's weblog" property="og:site_name"/><meta content="Jussi Judin's weblog" property="og:title"/><meta content="website" property="og:type"/><meta content="Programming related topics. Maybe even some original content!
" property="og:description"/><meta content="https://barro.github.io/page-2/" property="og:url"/><meta property="og:image" content="https://barro.github.io/icons/parruki-440.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@b4rr0"/><meta name="twitter:creator" content="@b4rr0"/><meta name="twitter:title" content="Jussi Judin's weblog"/><meta name="twitter:url" content="https://barro.github.io/page-2/"/><meta name="twitter:description" content="Programming related topics. Maybe even some original content!
"/><meta name="twitter:image:src" content="https://barro.github.io/icons/parruki-440.png"/></head><body><header class="site-header"><div class="wrapper"><a class="site-title" href="/">Jussi Judin's weblog</a><nav class="site-nav"> <a href="#" class="menu-icon"> <svg viewBox="0 0 18 15"> <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/> <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/> <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/> </svg> </a><div class="trigger"> <a class="page-link" href="/archive/">Archive</a> <a class="page-link" href="/author/">Author</a> <a class="page-link" href="https://feeds.feedburner.com/jussijudin">RSS</a></div> </nav></div></header><div class="page-content"><div class="wrapper"><div class="home"><h1 class="page-heading">Articles</h1><ul class="post-list"><li> <span class="post-meta">Sunday, Feb 28, 2016 • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jussi Judin</span></span></span><h2> <a class="post-link" href="/2016/02/being-a-good-cpu-neighbor/">Being a good CPU neighbor</a></h2><p>Very often computational tasks are roughly <a href="https://en.wikipedia.org/wiki/Processing_modes">divided</a> into <a href="https://en.wikipedia.org/wiki/Real-time_computing">real-time</a> and <a href="https://en.wikipedia.org/wiki/Batch_processing">batch processing</a> tasks. Sometimes you might want to run some tasks that take a large amount of computation resources, get the result as fast as possible, but you don’t really care exactly when you get the result out.</p><p>In larger organizations there are shared computers that usually have a lot of CPU power and memory available and that are mostly idle. But they are also used by other users that will be quite annoyed if they suffer from long delays to key presses or from similar issues because your batch processing tasks take all the resources that are available away from the system. Fortunately *nix systems provide different mechanisms available to non-root users to avoid these kind of issues.</p><p>These issue can also raise in situations where you have a system that can only allocate static resource requirements to tasks, like in <a href="https://jenkins-ci.org/">Jenkins</a>. As an example, you might have some test jobs that need to finish within certain time limit mixed with compilation jobs that should finish as soon as possible, but that can yield some resources to these higher priority test jobs, as they don’t have as strict time limitation requirements. And you usually don’t want to limit the resources that compilation jobs can use, if they are run on otherwise idle machine.</p><p>Here I’m specifically focusing on process priority settings and other CPU scheduling settings provided by Linux, as it currently happens to be probably the most used operating system kernel for multi-user systems. These settings affect how much CPU time a process gets relative to other processes and are especially useful on shared overloaded systems where there are more processes running than what there are CPU cores available.</p><h2 id="different-process-scheduling-priorities-in-linux">Different process scheduling priorities in Linux</h2><p>Linux and <a href="http://pubs.opengroup.org/onlinepubs/9699919799/">POSIX</a> interfaces provide different <a href="http://man7.org/linux/man-pages/man7/sched.7.html">scheduling policies</a> that define how <a href="https://www.kernel.org/doc/Documentation/scheduler/">Linux scheduler</a> allocates CPU time to a process. There are two main scheduling policies for processes: real-time priority policies and normal scheduling policies. Real-time policies are usually accessible only to root user and are not the point of interest of here, as they can not usually be used by normal users on shared systems.</p><p>At the time of the writing this article there are three normal scheduling policies available to normal users for process priorities:</p><ol><li><code class="highlighter-rouge">SCHED_OTHER</code>: the default scheduling policy in Linux with the default <a href="http://man7.org/linux/man-pages/man2/setpriority.2.html">dynamic priority</a> of 0.</li><li><code class="highlighter-rouge">SCHED_BATCH</code>: policy for scheduling batch processes. This schedules processes in similar fashion as <code class="highlighter-rouge">SCHED_OTHER</code> and is affected by the dynamic priority of a process. This makes the scheduler assume that the process is CPU intensive and makes it harder to wake up from a sleep.</li><li><code class="highlighter-rouge">SCHED_IDLE</code>: the lowest priority scheduling policy. Not affected by dynamic priorities. This equals to <a href="https://github.com/torvalds/linux/blob/v4.4/kernel/sched/core.c#L3860">nice level priority of 20</a>.</li></ol><p>The standard *nix way to change process priorities is to use <a href="http://man7.org/linux/man-pages/man1/nice.1.html"><code class="highlighter-rouge">nice</code></a> command. By default in Linux, process can get <a href="http://man7.org/linux/man-pages/man2/getpriority.2.html">nice values</a> of -20–19 where the default nice value for a process is 0. When process is started with <code class="highlighter-rouge">nice</code> command, the nice value will be</p><ol><li>Values 0–19 are available to a normal user and -20–-1 are available to the root user. The lowest priority nice value of 19 gives process <a href="https://www.kernel.org/doc/Documentation/scheduler/sched-nice-design.txt">5% of CPU time</a> with the default scheduler in Linux.</li></ol><p><a href="http://man7.org/linux/man-pages/man1/chrt.1.html"><code class="highlighter-rouge">chrt</code></a> command can be used to give a process access to <code class="highlighter-rouge">SCHED_BATCH</code> and <code class="highlighter-rouge">SCHED_IDLE</code> scheduling policies. <code class="highlighter-rouge">chrt</code> can be used with combination of <code class="highlighter-rouge">nice</code> command to lower the priority of <code class="highlighter-rouge">SCHED_BATCH</code> scheduling policy. And using <code class="highlighter-rouge">SCHED_IDLE</code> (= nice level 20) policy should give around 80% of the CPU time that nice level of 19 has, as nice level weights <a href="https://github.com/torvalds/linux/blob/v4.4/kernel/sched/sched.h#L1116">increase the process priority by 1.25 compared to lower priority level</a>.</p><h2 id="benchmarking-with-different-competing-workloads">Benchmarking with different competing workloads</h2><p>I wanted to benchmark the effect of different scheduling policies on a work done by a specific benchmark program. I used a system with Linux 3.17.0 kernel with <a href="http://ark.intel.com/products/65523/Intel-Core-i7-3770K-Processor-8M-Cache-up-to-3_90-GHz">Intel Core i7-3770K CPU at 3.5 GHz</a> processor with hyperthreading and frequency scaling turned on and 32 gigabytes of RAM. I didn’t manage to make the CPU frequency constant, so results vary a little between runs. I used John the Ripper’s bcrypt benchmark started with following command as the test program for useful work:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>/usr/sbin/john <span class="nt">--format</span><span class="o">=</span>bcrypt <span class="nt">-test</span>
</code></pre></div></div><p>I benchmarked 1 and 7 instances of John the Ripper for 9 iterations (9 * 5 = 45 seconds) with various amounts of non-benchmarking processes running at the same time. 1 benchmarking process should by default not have any cache contention resulting from other benchmarking processes happening and 7 benchmarking processes saturate all but 1 logical CPU core and can have cache and computational unit contention with each other.</p><p>Non-bechmarking processes were divided into different categories and there were 0–7 times CPU cores instances of them started to make them fight for CPU time with benchmarking processes. The results of running different amounts of non-benchmarking processes with different scheduling policies can be found from tables <a href="#cpu-looper-table-cpus-1">1</a>, <a href="#cpu-looper-table-cpus-7">2</a>, <a href="#mem-looper-table-cpus-1">3</a>, and <a href="#mem-looper-table-cpus-7">4</a>. Different scheduling policies visible in those tables are:</p><ul><li><em>default</em>: default scheduling policy. Command started without any wrappers. Corresponds to <code class="highlighter-rouge">SCHED_OTHER</code> with nice value of 0.</li><li><em>chrt-batch</em>: the default <code class="highlighter-rouge">SCHED_BATCH</code> scheduling policy. Command started with <code class="highlighter-rouge">chrt --batch 0</code> prefix.</li><li><em>nice 10</em>: <code class="highlighter-rouge">SCHED_OTHER</code> scheduling policy with the default nice value of 10. Command started with <code class="highlighter-rouge">nice</code> prefix.</li><li><em>nice 19</em>: <code class="highlighter-rouge">SCHED_OTHER</code> scheduling policy with nice value of 19. Command started with <code class="highlighter-rouge">nice -n 19</code> prefix. This should theoretically take around 5 % of CPU time out from the useful work.</li><li><em>nice 19 batch</em>: <code class="highlighter-rouge">SCHED_BATCH</code> scheduling policy with nice value of 19. Command started with <code class="highlighter-rouge">nice -n 19 chrt --batch 0</code> prefix.</li><li><em>sched idle</em>: <code class="highlighter-rouge">SCHED_IDLE</code> scheduling policy. Command started with <code class="highlighter-rouge">chrt --idle 0</code> prefix. This should theoretically take around 80 % of CPU time compared to nice level 19 out from useful work.</li></ul><p>The results in those tables reflect the relative average percentage of work done compared to the situation when there are no additional processes disturbing the benchmark. These only show the average value and do not show, for example, variance that could be useful to determine how close those values are of each other. You can download get the raw benchmarking data and the source code to generate and analyze this data from following links:</p><ul><li><a href="cpu-neighbor-source-code.tar.xz">Source code for test programs and generating and analyzing the data</a></li><li><a href="cpu-neighbor-benchmarks.tar.xz">Raw benchmarking data</a></li></ul><h3 id="cpu-looper">CPU looper</h3><p>CPU looper applications consists purely of an application that causes CPU load. Its main purpose is just to test the scheduling policies without forcing <a href="https://en.wikipedia.org/wiki/CPU_cache">CPU cache</a> misses. Of course there will be <a href="https://en.wikipedia.org/wiki/CPU_cache">context switches</a> that can replace data cache entries related to <a href="https://en.wikipedia.org/wiki/Context_(computing)">process state</a> and instruction cache entries for the process with another, but there won’t be any extra intentional cache flushing happening here.</p><p>The actual CPU looper application consists code shown in <a href="#cpu-neighbor-figure-1">figure 1</a> compiled without any optimizations:</p><figure id="cpu-neighbor-figure-1"><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><figcaption>Figure 1: source code for CPU looper program.</figcaption> </figure><p>The results for starting 0–7 times CPU cores of CPU looper processes with the default priority and then running benchmark with 1 or 7 cores can be found from tables <a href="#cpu-looper-table-cpus-1">1</a> and <a href="#cpu-looper-table-cpus-7">2</a>.</p><figure id="cpu-looper-table-cpus-1"><table style="margin:0 auto"><thead><tr><th style="text-align:left">1 worker</th><th style="text-align:right">0</th><th style="text-align:right">1</th><th style="text-align:right">2</th><th style="text-align:right">3</th><th style="text-align:right">4</th><th style="text-align:right">5</th><th style="text-align:right">6</th><th style="text-align:right">7</th></tr></thead><tbody><tr><td style="text-align:left"><em>default</em></td><td style="text-align:right">100</td><td style="text-align:right">64.6</td><td style="text-align:right">36.4</td><td style="text-align:right">25.5</td><td style="text-align:right">18.2</td><td style="text-align:right">15.4</td><td style="text-align:right">12.5</td><td style="text-align:right">11.0</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>sched batch</em></td><td style="text-align:right">100</td><td style="text-align:right">66.5</td><td style="text-align:right">37.0</td><td style="text-align:right">24.0</td><td style="text-align:right">16.3</td><td style="text-align:right">14.8</td><td style="text-align:right">12.2</td><td style="text-align:right">10.9</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 10</em></td><td style="text-align:right">100</td><td style="text-align:right">93.3</td><td style="text-align:right">90.2</td><td style="text-align:right">82.7</td><td style="text-align:right">75.4</td><td style="text-align:right">75.2</td><td style="text-align:right">75.0</td><td style="text-align:right">74.9</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 19</em></td><td style="text-align:right">100</td><td style="text-align:right">92.9</td><td style="text-align:right">90.4</td><td style="text-align:right">91.0</td><td style="text-align:right">91.8</td><td style="text-align:right">89.8</td><td style="text-align:right">89.4</td><td style="text-align:right">90.9</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 19 batch</em></td><td style="text-align:right">100</td><td style="text-align:right">94.0</td><td style="text-align:right">89.2</td><td style="text-align:right">91.4</td><td style="text-align:right">89.8</td><td style="text-align:right">86.4</td><td style="text-align:right">89.4</td><td style="text-align:right">90.7</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>95.0</strong></td><td style="text-align:right"><strong>91.3</strong></td><td style="text-align:right"><strong>92.2</strong></td><td style="text-align:right"><strong>92.0</strong></td><td style="text-align:right"><strong>92.6</strong></td><td style="text-align:right"><strong>91.0</strong></td><td style="text-align:right"><strong>92.4</strong></td></tr><tr><td style="text-align:left">—  </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>nice 19</em></td><td style="text-align:right">100</td><td style="text-align:right">80.0</td><td style="text-align:right">74.7</td><td style="text-align:right">68.0</td><td style="text-align:right">67.7</td><td style="text-align:right">67.5</td><td style="text-align:right">64.5</td><td style="text-align:right">60.7</td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>nice 19 batch</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>92.5</strong></td><td style="text-align:right">83.8</td><td style="text-align:right">75.9</td><td style="text-align:right">75.0</td><td style="text-align:right">74.3</td><td style="text-align:right">74.1</td><td style="text-align:right">69.8</td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right">89.8</td><td style="text-align:right"><strong>89.7</strong></td><td style="text-align:right"><strong>90.9</strong></td><td style="text-align:right"><strong>89.0</strong></td><td style="text-align:right"><strong>87.8</strong></td><td style="text-align:right"><strong>87.4</strong></td><td style="text-align:right"><strong>87.2</strong></td></tr><tr><td style="text-align:left">—  </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td></tr><tr><td style="text-align:left"><em>nice 19</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>77.9</strong></td><td style="text-align:right"><strong>69.7</strong></td><td style="text-align:right"><strong>66.9</strong></td><td style="text-align:right"><strong>66.3</strong></td><td style="text-align:right"><strong>64.6</strong></td><td style="text-align:right"><strong>63.4</strong></td><td style="text-align:right"><strong>58.1</strong></td></tr></tbody></table><figcaption>Table 1: the relative percentage of average work done for one benchmarking worker when there are 0–7 times the logical CPU cores of non-benchmarking CPU hogging jobs running with different scheduling policies.</figcaption> </figure><figure id="cpu-looper-table-cpus-7"><table style="margin:0 auto"><thead><tr><th style="text-align:left">7 workers</th><th style="text-align:right">0</th><th style="text-align:right">1</th><th style="text-align:right">2</th><th style="text-align:right">3</th><th style="text-align:right">4</th><th style="text-align:right">5</th><th style="text-align:right">6</th><th style="text-align:right">7</th></tr></thead><tbody><tr><td style="text-align:left"><em>default</em></td><td style="text-align:right">100</td><td style="text-align:right">49.8</td><td style="text-align:right">33.6</td><td style="text-align:right">24.6</td><td style="text-align:right">19.4</td><td style="text-align:right">16.4</td><td style="text-align:right">13.8</td><td style="text-align:right">12.2</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>sched batch</em></td><td style="text-align:right">100</td><td style="text-align:right">51.1</td><td style="text-align:right">34.0</td><td style="text-align:right">25.1</td><td style="text-align:right">20.0</td><td style="text-align:right">16.6</td><td style="text-align:right">14.2</td><td style="text-align:right">12.4</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 10</em></td><td style="text-align:right">100</td><td style="text-align:right">92.9</td><td style="text-align:right">87.2</td><td style="text-align:right">80.1</td><td style="text-align:right">75.0</td><td style="text-align:right">71.0</td><td style="text-align:right">66.3</td><td style="text-align:right">61.1</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 19</em></td><td style="text-align:right">100</td><td style="text-align:right">94.1</td><td style="text-align:right">94.9</td><td style="text-align:right">95.4</td><td style="text-align:right">95.2</td><td style="text-align:right">96.2</td><td style="text-align:right"><strong>95.7</strong></td><td style="text-align:right">96.0</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 19 batch</em></td><td style="text-align:right">100</td><td style="text-align:right">95.7</td><td style="text-align:right">95.2</td><td style="text-align:right">95.7</td><td style="text-align:right">95.5</td><td style="text-align:right">95.2</td><td style="text-align:right">94.6</td><td style="text-align:right">95.4</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>96.3</strong></td><td style="text-align:right"><strong>95.7</strong></td><td style="text-align:right"><strong>96.2</strong></td><td style="text-align:right"><strong>95.6</strong></td><td style="text-align:right"><strong>96.7</strong></td><td style="text-align:right">95.4</td><td style="text-align:right"><strong>96.7</strong></td></tr><tr><td style="text-align:left">—  </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>nice 19</em></td><td style="text-align:right">100</td><td style="text-align:right">93.6</td><td style="text-align:right">84.9</td><td style="text-align:right">78.0</td><td style="text-align:right">71.4</td><td style="text-align:right">65.7</td><td style="text-align:right">60.4</td><td style="text-align:right">56.2</td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>nice 19 batch</em></td><td style="text-align:right">100</td><td style="text-align:right">92.4</td><td style="text-align:right">84.1</td><td style="text-align:right">77.6</td><td style="text-align:right">69.9</td><td style="text-align:right">65.6</td><td style="text-align:right">60.7</td><td style="text-align:right">56.4</td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>95.5</strong></td><td style="text-align:right"><strong>94.9</strong></td><td style="text-align:right"><strong>94.5</strong></td><td style="text-align:right"><strong>93.9</strong></td><td style="text-align:right"><strong>94.3</strong></td><td style="text-align:right"><strong>93.7</strong></td><td style="text-align:right"><strong>91.9</strong></td></tr><tr><td style="text-align:left">—  </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td></tr><tr><td style="text-align:left"><em>nice 19</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>91.4</strong></td><td style="text-align:right"><strong>80.9</strong></td><td style="text-align:right"><strong>71.4</strong></td><td style="text-align:right"><strong>64.3</strong></td><td style="text-align:right"><strong>58.3</strong></td><td style="text-align:right"><strong>52.5</strong></td><td style="text-align:right"><strong>48.5</strong></td></tr></tbody></table><figcaption>Table 2: the relative percentage of average work done for seven benchmarking workers when there are 0–7 times the logical CPU cores of non-benchmarking CPU hogging jobs running with different scheduling policies.</figcaption> </figure><p>Tables <a href="#cpu-looper-table-cpus-1">1</a> and <a href="#cpu-looper-table-cpus-7">2</a> show that the effect is not consistent between different scheduling policies and when there is 1 benchmarking worker running it suffers more from the lower priority processes than what happens when there are 7 benchmarking workers running. But with higher priority scheduling policies for background processes the average amount of work done for 1 process remains higher for light loads than with 7 worker processes. These discrepancies can be probably explained by how hyperthreading works by sharing the same physical CPU cores and by caching issues.</p><h3 id="memory-looper">Memory looper</h3><p>Processors nowadays have multiple levels of cache and no cache isolation and memory access from one core can <a href="https://www.youtube.com/watch?v=QBu2Ae8-8LM#t=41m14s">wreak havoc for other cores</a> with just moving data from and to memory. So I wanted to see what happens with different scheduling policies when running multiple instances of a simple program that run on the background when John the Ripper is trying to do some real work.</p><figure id="cpu-neighbor-figure-2"><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdlib.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 2 * 20 megabytes should be enough to spill all caches.
</span>    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">data_size</span> <span class="o">=</span> <span class="mi">20000000</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">items</span> <span class="o">=</span> <span class="n">data_size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
    <span class="kt">long</span><span class="o">*</span> <span class="n">area_source</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
    <span class="kt">long</span><span class="o">*</span> <span class="n">area_target</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Just do some memory operations that access the whole memory area.
</span>        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">items</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">area_source</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">area_target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">items</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">area_target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">area_source</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><figcaption>Figure 2: source code for memory bandwidth hogging program.</figcaption> </figure><p>Program shown in <a href="#cpu-neighbor-figure-2">figure 2</a> is compiled without any optimizations and it basically reads one word from memory, adds 1 to it and stores the result to some other memory area and then <a href="https://en.wikipedia.org/wiki/Exclusive_or">XORs</a> the read memory area with the written memory area. So it basically does not do anything useful, but reads and writes a lot of data into memory every time the program gets some execution time.</p><p>Tables <a href="#mem-looper-table-cpus-1">3</a> and <a href="#mem-looper-table-cpus-7">4</a> show the relative effect on John the Ripper benchmarking program when there are various amounts of the program shown in <a href="#cpu-neighbor-figure-2">figure 2</a> running at the same time. If you compare these numbers to values shown in tables <a href="#cpu-looper-table-cpus-1">1</a> and <a href="#cpu-looper-table-cpus-7">2</a> a program that only uses CPU cycles is running, the numbers for useful work can be in some cases around 10 percentage points lower. So there is apparently some cache contention ongoing with this benchmarking program and the effect of lower priority scheduling policies is not the same that could be theoretically expected just from the allocated time slices.</p><figure id="mem-looper-table-cpus-1"><table><thead><tr><th style="text-align:left">1 worker</th><th style="text-align:right">0</th><th style="text-align:right">1</th><th style="text-align:right">2</th><th style="text-align:right">3</th><th style="text-align:right">4</th><th style="text-align:right">5</th><th style="text-align:right">6</th><th style="text-align:right">7</th></tr></thead><tbody><tr><td style="text-align:left"><em>default priority</em></td><td style="text-align:right">100</td><td style="text-align:right">61.7</td><td style="text-align:right">32.6</td><td style="text-align:right">21.8</td><td style="text-align:right">16.6</td><td style="text-align:right">13.3</td><td style="text-align:right">11.2</td><td style="text-align:right">9.8</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>sched batch</em></td><td style="text-align:right">100</td><td style="text-align:right">60.2</td><td style="text-align:right">32.6</td><td style="text-align:right">22.7</td><td style="text-align:right">16.2</td><td style="text-align:right">12.9</td><td style="text-align:right">10.9</td><td style="text-align:right">10.2</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 10</em></td><td style="text-align:right">100</td><td style="text-align:right">85.2</td><td style="text-align:right">82.1</td><td style="text-align:right">75.8</td><td style="text-align:right">70.8</td><td style="text-align:right">69.6</td><td style="text-align:right">70.5</td><td style="text-align:right">68.1</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 19</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>85.4</strong></td><td style="text-align:right"><strong>83.0</strong></td><td style="text-align:right">79.7</td><td style="text-align:right">81.7</td><td style="text-align:right">78.2</td><td style="text-align:right">81.9</td><td style="text-align:right"><strong>84.7</strong></td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 19 batch</em></td><td style="text-align:right">100</td><td style="text-align:right">83.8</td><td style="text-align:right">81.2</td><td style="text-align:right">80.5</td><td style="text-align:right"><strong>83.4</strong></td><td style="text-align:right">80.4</td><td style="text-align:right">79.4</td><td style="text-align:right">84.3</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right">82.9</td><td style="text-align:right">80.9</td><td style="text-align:right"><strong>81.2</strong></td><td style="text-align:right">82.1</td><td style="text-align:right"><strong>80.6</strong></td><td style="text-align:right"><strong>82.3</strong></td><td style="text-align:right">81.8</td></tr><tr><td style="text-align:left">—  </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>nice 19</em></td><td style="text-align:right">100</td><td style="text-align:right">80.0</td><td style="text-align:right">74.7</td><td style="text-align:right">68.0</td><td style="text-align:right">67.7</td><td style="text-align:right">67.5</td><td style="text-align:right">64.5</td><td style="text-align:right">60.7</td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>nice 19 batch</em></td><td style="text-align:right">100</td><td style="text-align:right">80.8</td><td style="text-align:right">74.1</td><td style="text-align:right">67.6</td><td style="text-align:right">67.1</td><td style="text-align:right">67.9</td><td style="text-align:right">65.5</td><td style="text-align:right">63.3</td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>83.9</strong></td><td style="text-align:right"><strong>81.6</strong></td><td style="text-align:right"><strong>79.2</strong></td><td style="text-align:right"><strong>77.0</strong></td><td style="text-align:right"><strong>75.9</strong></td><td style="text-align:right"><strong>76.8</strong></td><td style="text-align:right"><strong>77.1</strong></td></tr><tr><td style="text-align:left">—  </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td></tr><tr><td style="text-align:left"><em>nice 19</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>77.9</strong></td><td style="text-align:right"><strong>69.7</strong></td><td style="text-align:right"><strong>66.9</strong></td><td style="text-align:right"><strong>66.3</strong></td><td style="text-align:right"><strong>64.6</strong></td><td style="text-align:right"><strong>63.4</strong></td><td style="text-align:right"><strong>58.1</strong></td></tr><tr><td style="text-align:left"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td></tr></tbody></table><figcaption>Table 3: the relative percentage of average work done for one benchmarking worker when there are 0–7 times the logical CPU cores of non-benchmarking CPU and memory bandwidth hogging jobs running with different scheduling policies.</figcaption> </figure><figure id="mem-looper-table-cpus-7"><table><thead><tr><th style="text-align:left">7 workers</th><th style="text-align:right">0</th><th style="text-align:right">1</th><th style="text-align:right">2</th><th style="text-align:right">3</th><th style="text-align:right">4</th><th style="text-align:right">5</th><th style="text-align:right">6</th><th style="text-align:right">7</th></tr></thead><tbody><tr><td style="text-align:left"><em>default</em></td><td style="text-align:right">100</td><td style="text-align:right">48.4</td><td style="text-align:right">32.6</td><td style="text-align:right">24.5</td><td style="text-align:right">19.7</td><td style="text-align:right">16.3</td><td style="text-align:right">14.2</td><td style="text-align:right">12.3</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>sched batch</em></td><td style="text-align:right">100</td><td style="text-align:right">48.6</td><td style="text-align:right">32.2</td><td style="text-align:right">23.7</td><td style="text-align:right">19.4</td><td style="text-align:right">16.2</td><td style="text-align:right">14.0</td><td style="text-align:right">12.6</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 10</em></td><td style="text-align:right">100</td><td style="text-align:right">89.3</td><td style="text-align:right">81.5</td><td style="text-align:right">74.6</td><td style="text-align:right">69.2</td><td style="text-align:right">64.6</td><td style="text-align:right">60.4</td><td style="text-align:right">56.3</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 19</em></td><td style="text-align:right">100</td><td style="text-align:right">92.0</td><td style="text-align:right">90.5</td><td style="text-align:right">90.4</td><td style="text-align:right">91.2</td><td style="text-align:right">91.3</td><td style="text-align:right">90.6</td><td style="text-align:right">90.5</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>nice 19 batch</em></td><td style="text-align:right">100</td><td style="text-align:right">91.5</td><td style="text-align:right">91.8</td><td style="text-align:right"><strong>92.5</strong></td><td style="text-align:right"><strong>91.8</strong></td><td style="text-align:right">91.9</td><td style="text-align:right">92.1</td><td style="text-align:right">91.9</td></tr><tr><td style="text-align:left"><em>nice 0</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>92.1</strong></td><td style="text-align:right"><strong>91.9</strong></td><td style="text-align:right">91.9</td><td style="text-align:right">91.5</td><td style="text-align:right"><strong>92.0</strong></td><td style="text-align:right"><strong>92.4</strong></td><td style="text-align:right"><strong>92.1</strong></td></tr><tr><td style="text-align:left">—  </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>nice 19</em></td><td style="text-align:right">100</td><td style="text-align:right">85.4</td><td style="text-align:right">77.3</td><td style="text-align:right">70.4</td><td style="text-align:right">63.3</td><td style="text-align:right">58.3</td><td style="text-align:right">54.2</td><td style="text-align:right">50.3</td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>nice 19 batch</em></td><td style="text-align:right">100</td><td style="text-align:right">86.8</td><td style="text-align:right">77.7</td><td style="text-align:right">70.0</td><td style="text-align:right">63.4</td><td style="text-align:right">58.8</td><td style="text-align:right">54.4</td><td style="text-align:right">50.6</td></tr><tr><td style="text-align:left"><em>nice 10</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>90.6</strong></td><td style="text-align:right"><strong>89.0</strong></td><td style="text-align:right"><strong>88.9</strong></td><td style="text-align:right"><strong>88.9</strong></td><td style="text-align:right"><strong>88.0</strong></td><td style="text-align:right"><strong>87.4</strong></td><td style="text-align:right"><strong>86.3</strong></td></tr><tr><td style="text-align:left">—  </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td></tr><tr><td style="text-align:left"><em>nice 19</em> vs. <em>sched idle</em></td><td style="text-align:right">100</td><td style="text-align:right"><strong>82.8</strong></td><td style="text-align:right"><strong>72.9</strong></td><td style="text-align:right"><strong>62.9</strong></td><td style="text-align:right"><strong>57.3</strong></td><td style="text-align:right"><strong>52.2</strong></td><td style="text-align:right"><strong>48.2</strong></td><td style="text-align:right"><strong>44.1</strong></td></tr><tr><td style="text-align:left"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td><td style="text-align:right"> </td></tr></tbody></table><figcaption>Table 4: the relative percentage of average work done for seven benchmarking workers when there are 0–7 times the logical CPU cores of non-benchmarking CPU and memory bandwidth hogging jobs running with different scheduling policies.</figcaption> </figure><h2 id="conclusions">Conclusions</h2><p>These are just results of one specific benchmark with two specific workloads on one specific machine with 4 hyperthreaded CPU cores. They should anyways give you some kind of an idea how different CPU scheduling policies under Linux affect the load that you do not want to disturb when your machine is more or less overloaded. Clearly when you are reading and writing data from and to memory, the lower priority background process has bigger impact on the actual worker process than what the allocated time slices would predict. But, unsurprisingly, a single user can have quite a large impact on how much their long running CPU hogging processes affect rest of the machine.</p><p>I did not do any investigation how much work those processes that are supposed to disturb the benchmarking get done. In this case <code class="highlighter-rouge">SCHED_BATCH</code> with nice value of 19 could probably be the best scheduling policy if we want to get the most work done and at the same time avoid disturbing other users. Otherwise, it looks like the <code class="highlighter-rouge">SCHED_IDLE</code> policy, taken into use with <code class="highlighter-rouge">chrt --idle 0</code> command, that is promised to have the lowest impact on other processes has the lowest impact. Especially when considering processes started with lower nice values than the default one.</p></li><li> <span class="post-meta">Sunday, Feb 21, 2016 • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jussi Judin</span></span></span><h2> <a class="post-link" href="/2016/02/c-for-and-signed-integer-overflow/">C, for(), and signed integer overflow</a></h2><p>Signed integer overflow is <a href="https://en.wikipedia.org/wiki/Undefined_behavior">undefined behavior</a> in C language. This enables compilers to do all kinds of <a href="http://blog.llvm.org/2011/05/what-every-c-programmer-should-know.html">optimization tricks</a> that can lead to surprising and unexpected behavior between different compilers, compiler versions, and optimization levels.</p><p>I encountered something interesting when I tried different versions of <a href="https://gcc.gnu.org/">GCC</a> and <a href="http://clang.llvm.org/">clang</a> with following piece of code:</p><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;limits.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">INT_MAX</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">iterations</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">iterations</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><p>When compiling this with GCC 4.7, GCC 4.9, and clang 3.4 and compilation options for x86_64 architecture, we get following output variations:</p><figure><pre><code>$ gcc-4.9 --std=c11 -O0 tst.c &amp;&amp; ./a.out</code>
3
$ gcc-4.9 --std=c11 -O3 tst.c &amp;&amp; ./a.out
2
$ clang-3.4 --std=c11 -O3 tst.c &amp;&amp; ./a.out
4
$ gcc-4.7 --std=c11 -O3 tst.c &amp;&amp; ./a.out asdf
&lt;infinite loop...&gt;&lt;/code&gt;</pre></figure><p>So let’s analyze these results. The loop <code class="highlighter-rouge">for (int i = INT_MAX - 2; i &gt; 0; i++) {</code> should only iterate <code class="highlighter-rouge">3</code> times until variable <code class="highlighter-rouge">i</code> wraps around to negative value due to <a href="https://en.wikipedia.org/wiki/Two%27s_complement">two’s complement arithmetic</a>. Therefore we would expect <code class="highlighter-rouge">iterations</code> variable to be <code class="highlighter-rouge">3</code>. But this only happens when optimizations are turned off. So let’s see why these outputs result in these different values. Is there some clever loop unrolling that completely breaks here or what?</p><h2 id="gcc-49--o0">GCC 4.9 -O0</h2><p>There is nothing really interesting going in the assembly code produced by GCC without optimizations. It looks like what you would expect from this kind of loop <code class="highlighter-rouge">for()</code> on the lower level. So the main interest is in optimizations that different compilers do.</p><h2 id="gcc-49--o3-andclang-34--o3">GCC 4.9 -O3 and clang 3.4 -O3</h2><p>GCC 4.9 and clang 3.4 both seem to result in similar machine code. They both optimize the <code class="highlighter-rouge">for()</code> loop out and replace the result of it with a (different) constant. GCC 4.9 is just creating code that assigns value <code class="highlighter-rouge">2</code> to the second parameter for <code class="highlighter-rouge">printf()</code> function (see <a href="http://www.x86-64.org/documentation/abi.pdf">System V Application Binary Interface AMD64 Architecture Processor Supplement</a> section 3.2.3 about parameter passing). Similarly clang 3.4 assigns value <code class="highlighter-rouge">4</code> to the second parameter for <code class="highlighter-rouge">printf()</code>.</p><h3 id="gcc-49--o3-assembler-code-for-main">GCC 4.9 -O3 assembler code for main()</h3><p>Here we can see how value <code class="highlighter-rouge">2</code> gets passed as <code class="highlighter-rouge">iterations</code> variable:</p><figure><pre><code>Dump of assembler code for function main:
5 {
0x00000000004003f0 &lt;+0&gt;: sub $0x8,%rsp

6     int iterations = 0;
7     for (int i = INT_MAX - 2; i &gt; 0; i++) {
8         iterations++;
9     }
10     printf("%d\n", <strong>iterations</strong>);
<strong>0x00000000004003f4 &lt;+4&gt;: mov $0x2,%esi</strong>
0x00000000004003f9 &lt;+9&gt;: mov $0x400594,%edi
0x00000000004003fe &lt;+14&gt;: xor %eax,%eax
0x0000000000400400 &lt;+16&gt;: callq 0x4003c0 &lt;printf@plt&gt;

11     return 0;
12 }
0x0000000000400405 &lt;+21&gt;: xor %eax,%eax
0x0000000000400407 &lt;+23&gt;: add $0x8,%rsp
0x000000000040040b &lt;+27&gt;: retq
</code></pre></figure><h3 id="clang-34--o3-assembler-code-for-main">clang 3.4 -O3 assembler code for main()</h3><p>Here we can see how value <code class="highlighter-rouge">4</code> gets passed as <code class="highlighter-rouge">iterations</code> variable:</p><figure><pre><code>Dump of assembler code for function main:
5 {

6     int iterations = 0;
7     for (int i = INT_MAX - 2; i &gt; 0; i++) {
8         iterations++;
9     }
10     printf("%d\n", <strong>iterations</strong>);
0x00000000004004e0 &lt;+0&gt;: push %rax
0x00000000004004e1 &lt;+1&gt;: mov $0x400584,%edi
<strong>0x00000000004004e6 &lt;+6&gt;: mov $0x4,%esi</strong>
0x00000000004004eb &lt;+11&gt;: xor %eax,%eax
0x00000000004004ed &lt;+13&gt;: callq 0x4003b0 &lt;printf@plt&gt;
0x00000000004004f2 &lt;+18&gt;: xor %eax,%eax

11     return 0;
0x00000000004004f4 &lt;+20&gt;: pop %rdx
0x00000000004004f5 &lt;+21&gt;: retq
</code></pre></figure><h2 id="gcc-47--o3">GCC 4.7 -O3</h2><p>GCC 4.7 has an interesting result from optimizer that is completely different that could be expected to happen. It basically replaces <code class="highlighter-rouge">main()</code> function with just one instruction that does nothing else than jumps at the same address that it resides in and thus creates an infinite loop:</p><figure><pre><code>Dump of assembler code for function main:
5 {
0x0000000000<strong>400400</strong> &lt;+0&gt;: jmp <strong>0x400400</strong> &lt;main&gt;
</code></pre></figure><h2 id="conclusion">Conclusion</h2><p>This is an excellent example of <a href="http://www.catb.org/jargon/html/N/nasal-demons.html">nasal demons</a> happening when there is undefined behavior ongoing and compilers have free hands to do anything they want. Especially as GCC 4.7 produces really harmful machine code that instead of producing unexpected value as a result, it just makes the program unusable. Other compilers and other architectures could result in different behavior, but let that be something for the future investigation.</p></li><li> <span class="post-meta">Sunday, Feb 14, 2016 • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jussi Judin</span></span></span><h2> <a class="post-link" href="/2016/02/shell-script-patterns-for-bash/">Shell script patterns for bash</a></h2><p>I write a lot of shell scripts using bash to glue together existing programs and their data. I have noticed that some patterns have emerged that I very often use when writing these scripts nowadays. Let the following script to demonstrate:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="nb">set</span> <span class="nt">-u</span>  <span class="c"># Exit if undefined variable is used.</span>
<span class="nb">set</span> <span class="nt">-e</span>  <span class="c"># Exit after first command failure.</span>
<span class="nb">set</span> <span class="nt">-o</span> pipefail  <span class="c"># Exit if any part of the pipe fails.</span>

<span class="nv">ITERATIONS</span><span class="o">=</span><span class="nv">$1</span>  <span class="c"># Notice that there are no quotes here.</span>
<span class="nb">shift
</span><span class="nv">COMMAND</span><span class="o">=(</span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span><span class="o">)</span>  <span class="c"># Create arrays from commands.</span>

<span class="nv">DIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">"</span><span class="k">$(</span>readlink <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span><span class="k">)</span>  <span class="c"># Get the script directory.</span>
<span class="nb">echo</span> <span class="s2">"Running '</span><span class="k">${</span><span class="nv">COMMAND</span><span class="p">[*]</span><span class="k">}</span><span class="s2">' in </span><span class="nv">$DIR</span><span class="s2"> for </span><span class="nv">$ITERATIONS</span><span class="s2"> iterations"</span>

<span class="nv">WORKDIR</span><span class="o">=</span><span class="k">$(</span>mktemp <span class="nt">--directory</span><span class="k">)</span>
<span class="k">function </span>cleanup<span class="o">()</span>
<span class="o">{</span>
    rm <span class="nt">-rf</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span>
<span class="o">}</span>
<span class="nb">trap </span>cleanup EXIT  <span class="c"># Make sure that we clean up in any situation.</span>

<span class="k">for </span>_ <span class="k">in</span> <span class="k">$(</span>seq 1 <span class="s2">"</span><span class="nv">$ITERATIONS</span><span class="s2">"</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    <span class="o">(</span>  <span class="c"># Avoid the effect of "cd" command from propagating.</span>
        <span class="nb">cd</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span>
        <span class="s2">"</span><span class="k">${</span><span class="nv">COMMAND</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span> <span class="se">\ </span> <span class="c"># Execute command from an array.</span>
            | <span class="nb">cat</span>
    <span class="o">)</span>
<span class="k">done</span></code></pre></figure><h2 id="fail-fast-in-case-of-errors">Fail fast in case of errors</h2><p>Lines <code class="highlighter-rouge">3</code>–<code class="highlighter-rouge">5</code> are related to handling erroneous situations. If any of the situations happen that these settings have effect on, they will exit the shell script and prevent it running further. They can be combined to <code class="highlighter-rouge">set -ueo pipefail</code> as a shorthand notation.</p><p>A very common mistake is to have an undefined variable, by just forgetting to set the value, or mistyping a variable name. <code class="highlighter-rouge">set -u</code> at line <code class="highlighter-rouge">3</code>prevents these kind of issues from happening. Other very common situation in shell scripts is that some program is used incorrectly, it fails, and then rest of the shell script just continues execution. This then causes hard to notice failures later on. <code class="highlighter-rouge">set -e</code> at line <code class="highlighter-rouge">4</code> prevents these issues from happening. And because life is not easy in bash, we need to ensure that such program execution failures that are part of pipelines are also caught. This is done by <code class="highlighter-rouge">set -o pipefail</code> on line <code class="highlighter-rouge">5</code>.</p><h2 id="clean-up-after-yourself-even-in-unexpected-situations">Clean up after yourself even in unexpected situations</h2><p>It’s always a good idea to use unique temporary files or directories for anything that can be created during runtime that is not a specific target of the script. This makes sure that even if many instances of the script are executed in parallel, there won’t be any race condition issues. <code class="highlighter-rouge">mktemp</code> command on line <code class="highlighter-rouge">14</code> shows how to create such temporary files.</p><p>Creating temporary files and directories poses a problem where they may not be deleted if the script is exited too early or if you forget to do a manual cleanup. <code class="highlighter-rouge">cleanup()</code> function shown at lines <code class="highlighter-rouge">15</code>–<code class="highlighter-rouge">18</code> includes code that makes sure that the script cleans up after itself and <code class="highlighter-rouge">trap cleanup EXIT</code> makes sure that <code class="highlighter-rouge">cleanup()</code> is implicitly called in any situation where this script may exit.</p><h2 id="executing-commands">Executing commands</h2><p>Something that is often seen in shell scripts that when you need to create a variable that has a command with arguments, you then execute the variable as it is (<code class="highlighter-rouge">$COMMAND</code>) without using any safety mechanisms against <a href="http://www.golemtechnologies.com/articles/shell-injection">input that can lead into unexpected results in the shell script</a>. Lines <code class="highlighter-rouge">9</code> <code class="highlighter-rouge">COMMAND=("$@")</code> and <code class="highlighter-rouge">24</code> <code class="highlighter-rouge">"${COMMAND[@]}"</code> show a way to assign a command into an array and run such array as command and its parameters. Line <code class="highlighter-rouge">25</code> then includes a pipe just to demonstrate that <code class="highlighter-rouge">set -o pipefail</code> works if you pass a command that fails.</p><h2 id="script-directory-reference">Script directory reference</h2><p>Sometimes it’s very useful to access other files in the same directory where the executed shell script resides in. Line <code class="highlighter-rouge">11</code> <code class="highlighter-rouge">DIR=$(dirname "$(readlink -f "$0")")</code> basically gives the absolute path to the current shell script directory. The order of <code class="highlighter-rouge">readlink</code> and <code class="highlighter-rouge">dirname</code> commands can be changed depending if you want to access the directory where the command to execute this script points to or where the script actually resides in. These can be different locations if there is a symbolic link to the script. The order shown above points to the directory where the script is physically located at.</p><h2 id="quotes-are-not-always-needed">Quotes are not always needed</h2><p>Normally in bash if you reference variables without enclosing them into quotes, you risk of shell injection attacks. But when assigning variables in bash, you don’t need to have quotes in the assignment as long as you don’t use spaces. The same applies to <a href="https://www.gnu.org/software/bash/manual/html_node/Command-Substitution.html">command substitution</a> (<a href="https://google.github.io/styleguide/shell.xml?showone=Use_Local_Variables#Use_Local_Variables">some caveats with variable declarations apply</a>). This style is demonstrated on lines <code class="highlighter-rouge">7</code> <code class="highlighter-rouge">ITERATIONS=$1</code>and <code class="highlighter-rouge">11</code> <code class="highlighter-rouge">DIR=$(...)</code>.</p><h2 id="shellcheck-your-scripts">Shellcheck your scripts</h2><p>One cool program that will make you a better shell script writer is <a href="http://www.shellcheck.net/">ShellCheck</a>. It basically has a list of issues in shell scripts that it detects and can notify you whenever it notices issues that should be fixed. If you are writing shell scripts as part of some version controlled project, you should add an automatic ShellCheck verification step for all shell scripts that you put into your repository.</p></li><li> <span class="post-meta">Sunday, Feb 7, 2016 • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jussi Judin</span></span></span><h2> <a class="post-link" href="/2016/02/a-succesful-git-branching-model-considered-harmful/">A succesful Git branching model considered harmful</a></h2><blockquote><p>Update 2018-07. The branching model described here is called trunk based development. I and other people who I collaborated with did not know about the articles that used this name. Nowadays there are excellent web resources about the subject, like <a href="https://trunkbaseddevelopment.com/">trunkbaseddevelopment.com</a>. They have a lot of material about this and other key subjects revolving around the area of efficient software development.</p></blockquote><p>When people start to use <a href="https://git-scm.com/">git</a> and get introduced to branches and to the ease of branching, they may do couple of Google searches and very often end up on a blog post about <a href="http://nvie.com/posts/a-successful-git-branching-model/">A successful Git branching model</a>. The biggest issue with this article is that it comes up as one of the first ones in many git branching related searches when it should serve as a warning how not to use branches in software development.</p><h2 id="what-is-wrong-with-a-successful-git-branching-model">What is wrong with “A successful Git branching model”?</h2><p>To put it bluntly, this type of development approach where you use shared remote branches for everything and merge them back as they are is much more complicated than it should be. The basic principle in making usable systems is to have sane defaults. This branching model makes that mistake from the very beginning by not using the <code class="highlighter-rouge">master</code> branch for something that a developer who clones the repository would expect it to be used, development.</p><p>Using individual (long lived) branches for features also make it harder to ensure that everything works together when changes are merged back together. This is especially pronounced in today’s world where <a href="http://www.martinfowler.com/articles/continuousIntegration.html">continuous integration</a> should be the default practice of software development regardless how big the project is. By integrating all changes together regularly you’ll avoid big integration issues that waste a lot of time to resolve, especially for bigger projects with hundreds or thousands of developers. This type of development practice where every feature is developed in its own shared remote branch drives the process naturally towards big integration issues instead of avoiding them.</p><p>Also in “A successful Git branching model” merge commits are encouraged as the main method for integrating changes. I will explain next why merge commits are bad and what you will lose by using them.</p><h3 id="what-is-wrong-with-merge-commits">What is wrong with merge commits?</h3><p>“A successful Git branching model” talks how non-fast-forward merge commits can be thought as a way to keep all commits related to a certain feature nicely in one group. Then if you decide that a feature is not for you, you can just revert that one commit and have the whole feature removed. I would argue that this is a really rare situation that you revert a feature or that you even get it done completely right on the first try.</p><p>Merges in git very often create additional commits that begin with the message that looks like following: “<code class="highlighter-rouge">Merge branch 'some-branch' of git://git.some.domain/repository/</code>”. That does not provide any value when you want to see what has actually changed. You need go to the commit message and read what happens there, probably in the second paragraph. Not to mention going back in history to the branch and trying to see what happens in that branch.</p><p>Having non-linear history also makes <a href="https://git-scm.com/docs/git-bisect">git bisect</a> harder to do when issues are only revealed during integration. You may have both of the branches good individually but then the merge commit fails because your changes don’t conflict. This is not even that hard to encounter when one developer changes some internal interface and other developer builds something new based on the old interface definition. These kind of can be easy or hard to figure out, but having the history linear without any merge commits could immediately point out the commit that causes issues.</p><h2 id="something-more-simple">Something more simple</h2><figure class="pull-right text-center" id="figure-cactus-model"> <a href="https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/cactus-model.pdf"> <img src="https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/cactus-model-100.png" alt="The cactus model" width="190px" height="538px" title="The cactus model" class="figure-image" srcset="https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/cactus-model-100.png 1.0x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/cactus-model-125.png 1.25x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/cactus-model-150.png 1.5x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/cactus-model-200.png 2.0x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/cactus-model-300.png 3.0x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/cactus-model-400.png 4.0x"/> </a> <figcaption>Figure 1: The cactus model</figcaption> </figure><p>Let me show a much more simple alternative, that we can call the cactus model. It gets the name from the fact that all branches branch out from a wide trunk (<code class="highlighter-rouge">master</code> branch) and never get merged back. Cactus model should reflect much better the way that comes up naturally when working with git and making sure that continuous integration principles are used.</p><p>In <a href="#figure-cactus-model">figure 1</a> you can see the principle how the cactus branching model works and following sections explain the reasoning behind it. Some principles shown here may need <a href="https://www.gerritcodereview.com">Gerrit</a> or similar integrated code review and repository management system to be fully usable.</p><h3 id="all-development-happens-on-the-master-branch">All development happens on the master branch</h3><p><code class="highlighter-rouge">master</code> branch is the default that is checked out after <code class="highlighter-rouge">git clone</code>. So why not also have all development also happen there? No need to guess or needlessly document the development branch when it is the default one. This only applies to the central repository that is cloned and kept up to date by everyone. Individual developers are encouraged to use local branches for development but avoid shared remote branches.</p><p>Developers should <code class="highlighter-rouge">git rebase</code> their changes regularly so that their local branches would follow the latest <code class="highlighter-rouge">origin/master</code>. This is to make sure that we do not develop on an outdated baseline.</p><h4 id="using-local-branches">Using local branches</h4><p>Cactus model does not to discourage using branches when they are useful. Especially an individual developer should use short lived feature branches in their local repository and integrate them with the <code class="highlighter-rouge">origin/master</code> whenever there is something that can be shared with everyone else. Local branches are just to make it more easy to move between features while commits are tested or under code review.</p><p>Figures <a href="#figure-rebase-1">2</a> and <a href="#figure-rebase-2">3</a> show the basic principle of local branches and rebases by visualizing a tree state. In <a href="#figure-rebase-1">figure 2</a> we have a situation with two active local development branches (fuchsia circles) and one branch that is under code review (blue circles) and ready to be integrated to <code class="highlighter-rouge">origin/master</code> (yellow circles). In <a href="#figure-rebase-2">figure 3</a> we have updated the <code class="highlighter-rouge">origin/master</code> with two new commits (yellow-blue circles) and submitted two commits for code review (blue circle) and consider them to be ready for integration. As branches don’t automatically disappear from the repository, the integrated commits are still in the local repository (gray circles), but hopefully forgotten and ready to be <a href="https://git-scm.com/docs/git-gc">garbage collected</a>.</p><div class="text-center"> <figure class="inline-figure" id="figure-rebase-1"> <a href="https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-1.pdf"> <img src="https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-1-100.png" alt="Local cactus branches" width="265" height="190" title="Local cactus branches" class="figure-image" srcset="https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-1-100.png 1.0x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-1-125.png 1.25x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-1-150.png 1.5x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-1-200.png 2.0x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-1-300.png 3.0x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-1-400.png 4.0x"/> </a> <figcaption>Figure 2: Local development branches</figcaption> </figure> <figure class="inline-figure" id="figure-rebase-2"> <a href="https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-2.pdf"> <img src="https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-2-100.png" alt="Local cactus after integration and rebase" width="328" height="190" class="figure-image" title="Local cactus after integration and rebase" srcset="https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-2-100.png 1.0x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-2-125.png 1.25x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-2-150.png 1.5x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-2-200.png 2.0x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-2-300.png 3.0x, https://barro.github.io/2016/02/a-succesful-git-branching-model-considered-harmful/rebase-2-400.png 4.0x"/> </a> <figcaption>Figure 3: Local branches after integration and rebase</figcaption> </figure></div><h4 id="shared-remote-branches">Shared remote branches</h4><p>As a main principle, shared remote branches should be avoided. All changes should be made available on <code class="highlighter-rouge">origin/master</code> and other developers should build their changes on top of that by continuously updating their working copies. This ensures that we do not end up in <a href="http://c2.com/xp/IntegrationHell.html">integration hell</a> that will happen when many feature branches need to be combined at once.</p><p>If you use staged code review system, like Gerrit or github, then you can just <code class="highlighter-rouge">git fetch</code> the commit chain and build on top of that. Then <code class="highlighter-rouge">git push</code> your changes to your own repository to some specific branch, that you have hopefully rebased on top of the <code class="highlighter-rouge">origin/master</code> before pushing.</p><h3 id="releases-are-branched-out-from-originmaster">Releases are branched out from origin/master</h3><p>Releases get their own tags or branches that are branched out from <code class="highlighter-rouge">origin/master</code>. In case we need a hotfix, just add that to the release branch and cherry-pick it to the master branch, if applicable. By using some specific tagging and branching naming scheme should enable for automatic releases but this should be completely invisible to developers in their daily work.</p><h3 id="there-are-only-fast-forward-merges">There are only fast-forward merges</h3><p><code class="highlighter-rouge">git merge</code> is not used. Changes go to <code class="highlighter-rouge">origin/master</code> by using <code class="highlighter-rouge">git rebase</code> or <code class="highlighter-rouge">git cherry-pick</code>. This avoids cluttering the repository with merge commits that do not really provide any real value and avoids <a href="http://stackoverflow.com/questions/14023648/why-does-my-git-history-look-like-a-christmas-tree">christmas tree look</a> on the repository. Rebasing also makes the history linear, so that <code class="highlighter-rouge">git bisect</code> is really easy to use for finding regressions.</p><p>If you are using Gerrit, you can also use cherry-pick submit strategy. This simply enables putting a collection of commits to <code class="highlighter-rouge">origin/master</code> at any desired order instead of having to settle for the order decided when commits were first put for a code review.</p><h2 id="concluding-remarks">Concluding remarks</h2><p>Git is really cool as a version control system. You can do all kinds of nifty stuff with it really easily that was hard or impossible to do. Branches are just <a href="https://git-scm.com/book/en/v1/Git-Internals-Git-References">pointers to certain commits</a> and that way you can create a branch really cheaply from anything. Also you can do all kinds of <a href="https://git-scm.com/docs/git-merge#_merge_strategies">fancy merges</a> and this makes using and mixing branches very easy. But as with all tools, branches should be used appropriately to make it more easy for developers to their daily development tasks, not harder by default.</p><p>I have also seen these kind of scary development practices to be used in projects with hundreds of developers when moving to git from some other version control systems. Some organizations even take this as far as they fully remove the <code class="highlighter-rouge">master</code> branch from the central repository and create all kinds of questions and obstacles by not having a sane default that is expected by anyone who has used git anywhere else.</p></li><li> <span class="post-meta">Sunday, Jan 31, 2016 • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jussi Judin</span></span></span><h2> <a class="post-link" href="/2016/01/software-development-blog/">Starting a software development blog</a></h2><p>Isn’t it a nice way to start a software development related blog by talking about how to start a software development related blog? Or at least it goes one up in the meta blogging level where there is an article about what needs taken care of when creating a software development related blog that starts with how meta this is.</p><h2 id="arent-there-tons-of-articles-regarding-this-already">Aren’t there tons of articles regarding this already?</h2><p>There are tons of articles about how to establish a blog. Some of them are very good at giving generic advice on topics and blogging platform selection, and you should use your favorite search engine to search for those. I’m just going to explain my reasoning for choices I have made when establishing this blog with my current understanding and background research.</p><h2 id="why-blog-at-all">Why blog at all?</h2><p>Why should I blog at all? Blogging takes time and effort and I will probably lose interest in it after some weeks/months/years. The biggest reason for me to start blogging is that I find myself very often explaining things through email discussions, wikis, or chats, sometimes the same things multiple times. Also sometimes I just do benchmarks and other types of digging and comparison, and I would like to have a place to present these findings where I can easily link to.</p><p>What I’m not after here is being a part of some specific blogging community. The second thing that I try to avoid is discussing topics that are not software development related, or just share some links with a very short comment on them. Those things I leave for Facebook and Internet relay chat type of communication platforms.</p><h3 id="coming-up-with-ideas">Coming up with ideas</h3><p>I have collected ideas and drafts that I could write about for almost a year now. And there are over a dozen different smaller or larger article ideas in my backlog. So at least in the beginning I have some material available. The biggest question is that do I find this interesting enough to continue doing and how often do I come up with new ideas that I could blog about.</p><h2 id="deciding-the-language-i-write-articles-in">Deciding the language I write articles in</h2><p>I have decided to write my blog in English. It’s not my first, or even my second language, so why write a blog in English? The reason for this is that software development topics come up naturally for me in English. Also people who may be interested in these topics basically have to know English to have any competence in this industry and I’m not aiming at complete beginners.</p><h2 id="selecting-a-blogging-platform">Selecting a blogging platform</h2><p>I had a couple of requirements for a blogging platform that it should satisfy so it would fit my needs:</p><ul><li>Hosted by a third party. I have hosted my own web server and it requires somewhat constant maintenance and I want to avoid that. Especially I don’t want to have constant <a href="https://premium.wpmudev.org/blog/wordpress-security-exploits/">security issues</a>.</li><li>To be able to write articles locally on my computer and then easily export the result to the blog. Also as articles generally take quite a few trials and errors, they should be easy to modify.</li><li>Support source code listings and syntax coloring.</li><li>Be able to upload files of any type to the platform and link to them. I know that I would like to produce source code, so why not give out larger programs directly as files without having to list all the source code in the article?<ul><li>These files should be easy to modify as, as mentioned before, articles take some iterations to be complete.</li></ul></li></ul><p>First I was thinking about using <a href="https://www.blogger.com/">Blogger</a> as my blogging platform, as quite a few blogs that I follow use it as their platform. But I wasn’t convinced that the transfer of files from local machine to Blogger service would be the most convenient, especially with images and other types of files. Then I remembered that some people have pages on <a href="https://pages.github.com/">GitHub</a> and stumbled upon <a href="https://jekyllrb.com/">Jekyll</a> that creates static files and is aimed specifically for this kind of content creation. So that’s what I decided to use for now.</p><p>Jekyll does require some work to be set up and probably to maintain, but at least it frees me to do the content in any way I like to. Many of the things that I also need to currently do manually would probably have been taken care of by some plugins on third party blogging services. But that’s the price of doing this in a more customizable way.</p><h2 id="coming-up-with-some-basic-information">Coming up with some basic information</h2><p>Should I add a personal biography to the blog, or should people who have not met me know me just by the name and the content that I write? I have decided to write a little bit about myself that would hopefully shed a light on who I am. But I have decided not to use <a href="https://barro.github.io/author/">the author page</a> as my curriculum vitae, as it would get too long and boring.</p><h2 id="deciding-how-this-blog-should-look-and-feel">Deciding how this blog should look and feel</h2><p>As a general rule when making personal web pages, I try to make them load fast and avoid images. And with this blog, I just took the default Jekyll theme and started customizing it in certain aspects where I want to have more information visible. As new devices with different resolutions come into market and browsers get updated, I may need to update this to something that better supports the reactive nature of the website that I hope to have.</p><p>One interesting direction where web development is going into regarding the pages optimized for mobile devices is to have <a href="https://www.ampproject.org/">accelerated mobile pages</a> of the content. Currently I have decided to write as much content as possible in <a href="https://daringfireball.net/projects/markdown/">Markdown</a> that is processed by <a href="http://kramdown.gettalong.org/">kramdown</a> Markdown processor. It doesn’t natively support accelerated mobile pages yet, so I have opted out from using accelerated mobile pages for now. In the future it would be really nice to have lazy image loading and support for <a href="https://css-tricks.com/responsive-images-youre-just-changing-resolutions-use-srcset/">responsive images</a> with different sizes and device support.</p><h3 id="favicon">Favicon</h3><p>Favicon is a small image that should make a site stand out from rest when you have multiple tabs open in a browser, bookmarks, and when creating icons of websites/applications to a device or operating system. I had made a favicon for my web site ages ago. I still have the original high resolution version, so now I decided to see what kind of different formats and sizes there are for these icons. Fortunately I didn’t have to look too much, as I found a website called <a href="http://realfavicongenerator.net/">Real Favicon Generator.net</a> that would take care of converting this icon to different formats for me.</p><p>I was a little blown away by how many different targets there are for these kinds of icons. The generated file collection included 27 different images and 2 metadata files in addition to code to add to a website header. A current list of them looks like this:</p><ul><li><a href="https://en.wikipedia.org/wiki/Favicon">Favicon</a> for website in different sizes and formats.</li><li><a href="https://developer.apple.com/library/ios/documentation/AppleApplications/Reference/SafariWebContent/pinnedTabs/pinnedTabs.html">Safari’s pinned tabs</a>.</li><li>Windows 8 and Windows 10 <a href="https://msdn.microsoft.com/en-us/library/dn455106(v=vs.85).aspx">pinned website tiles</a></li><li><a href="https://support.mozilla.org/en-US/kb/how-add-shortcut-website-android">Android home screen icon</a></li><li><a href="https://developer.apple.com/library/ios/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html">iOS home screen icon</a></li></ul><p>In a couple of years we probably have new systems and resolutions to support. So I need to regenerate these favicons again to support those new systems.</p><h3 id="responsive-images">Responsive images</h3><p>Some images that I produce are originally made with <a href="https://inkscape.org/">Inkscape</a> in vector graphics format. Unfortunately the browser support for vector graphics formats is appalling, the next best option is to use <a href="https://responsiveimages.org/">responsive images</a> that provide different resolution versions of the image based on the display device capabilities. Every vector graphic image has 6 versions (100%, 125%, 150%, 200%, 300%, 400%, and PDF) of it generated, which can then be used in <a href="https://html.spec.whatwg.org/multipage/embedded-content.html#attr-img-srcset">srcset</a> image attribute which enables devices with higher density screens to get more crisp images. Higher density images are also used in modern browsers when the page is zoomed. PDF versions are just used in clickable links, as PDF files as images don’t really have that good of a browser support yet.</p><h2 id="optimize-everything">Optimize everything!</h2><p>When writing content or doing anything with the layout, I naturally want to have them as easy to edit as possible. That also means that if I don’t minify HTML, CSS, images and other often rendered resources on the page, I will lose on page load time. I would like the Jekyll plugins to optimize everything that is produced, but unfortunately only <a href="http://jekyllrb.com/docs/assets/">Sass/SCSS assets</a> provide easy minifying options. So page HTML is not minified, even though in the front page’s case it could reduce its size by some percents.</p><p>Every PNG image on this blog is optimized by using <a href="https://github.com/google/zopfli">ZopfliPNG</a>. It produces around 10% smaller images than <a href="http://optipng.sourceforge.net/">OptiPNG</a>, that is the standard open source PNG optimizer. ZopfliPNG takes its time, especially on larger images, but as the optimization only needs to be done just before publishing, it’s worth doing, as it can easily save 10–50% in image size. Also if PNG images are not meant to be as high quality representations as possible of something, they have their color space reduced by <a href="https://pngquant.org/">pngquant</a> if the color space reduction does not result in a significant quality deterioration. This can result in savings excess of 50% while still keeping the image format appropriate for line drawings and other high frequency image data.</p><p>Every article has its own <a href="https://en.wikipedia.org/wiki/Identicon">identicon</a> and that would result in an extra request if I were to add its as a simple image. Instead I embed it to the page source by using <a href="https://en.wikipedia.org/wiki/Base64">base64 encoded</a> <a href="https://en.wikipedia.org/wiki/Data_URI_scheme">data URI scheme</a> for the around 200 bytes that these page identifier images result in. I could shave off some bytes by selecting between image formats that take the least space to encode the same information. I don’t think that I need to go that far, as I usually have far more text on a page than what images usually take.</p><p>Another place that I can optimize is to move all the content that is not required for initial page rendering at the end of the page. This it also possible to load some content asynchronously after the page has initially loaded itself. This mostly means that I have moved all Javascript this page has to the end of the page. Also <a href="https://developers.google.com/speed/pagespeed/insights/">Google’s PageSpeed Insights</a> gives good hints on what else to optimize and one place to optimize is to either inline or load CSS asynchronously. Unfortunately Jekyll has not made it easy to include the generated CSS file as a part of the document so instead of fighting it, I have opted to have it as a separate file. The second option to load that CSS file asynchronously unfortunately creates an annoying effect when the page is loaded and then the style sheets are applied due to <a href="https://en.wikipedia.org/wiki/Hamburger_button">the hamburger button</a>, so I left the main style sheet to be synchronously loaded in the header.</p><p>One place to still optimize would be the style sheets that these pages have, but as this layout should be lightweight enough already, I hope that I can survive without having to optimize the things that affect layout rendering.</p><p>The front page of this blog has 5 articles with full content visible. I have opted for that option simply because I have noticed that I like reading blogs where I don’t need to open any pages to get to the content. Having less articles per page would make the front page load faster and more articles would help in avoiding page switches, so I hope that this is a decent compromise.</p><p>All size optimizations are, in the end, pretty much overwhelmed by just adding <a href="https://disqus.com/">Disqus</a> as a commenting platform, as it loads much more data than an average article and also includes dozens of different files that a browser needs to fetch.</p><h2 id="two-way-communication">Two-way communication</h2><p>One of the powerful features of any blogging platform is that they enable context related two-way communication between the author and the readers. This means that some blogs have comments. As I’m using static pages, the easiest solution is just to leave the commenting options out. But I decided to opt in for <a href="https://disqus.com/">Disqus</a> as a commenting system for now, especially because there is <a href="http://www.perfectlyrandom.org/2014/06/29/adding-disqus-to-your-jekyll-powered-github-pages/">a nice post explaining what you need to do with Jekyll to use Disqus on GitHub pages</a>.</p><p>Disqus has its haters and issues, but I think that it’s the best bet for now. If I spend most of my time deleting spammy comments, I will then probably just abandon commenting features altogether and let people comment on Twitter or by using some other means, if they feel that’s necessary and are interested enough.</p><h2 id="linking-to-myself">Linking to myself</h2><p>As I have some presence on multiple social media sites and some personal project resources, I have decided to include the most current ones in the footer of the page.</p><h2 id="is-there-actually-anyone-who-reads-my-blog">Is there actually anyone who reads my blog?</h2><p>As I have opted to use a third party web hosting service with this, I don’t have access to their logs and therefore can’t really know how many page loads I get. So I take the second option and use full blown <a href="http://www.google.com/analytics/">Google Analytics</a> service for this blog. It also provides much better data analysis features than any of the web service log analyzers that I have used, so at least by using it I should have some kind of an idea how many people actually visit this blog.</p><p>Also using <a href="https://www.feedburner.com/">FeedBurner</a> should provide me statistics on how many people have subscribed to my blog.</p><h2 id="article-feeds">Article feeds</h2><p>For me article feeds have two purposes: to provide the subscribers of this blog an easy access to new articles and for me some kind of an idea how many people are regularly reading this blog. Displaying the full article content in the feed is the approach that I like when reading my feed subscriptions, as I can read the whole article in the feed reader. I decided to use a third party feed service, <a href="https://www.feedburner.com/">FeedBurner</a> to get feed subscriber statistics. FeedBurner also provides services I can use to further modify my feed, like making it more compatible with different devices and feed readers.</p><h2 id="adding-a-search">Adding a search</h2><p>One thing with a website with a lot of content is that it should be possible to find the content. One way is to add a search to the website, but it’s not that easy to do if the website is a collection of static pages. I have now decided to opt out of adding a separate search widget and hope that <a href="https://barro.github.io/archive/">the article list</a> is enough. If there are any specific articles which interest people, web search engines would bring those up.</p><h2 id="link-all-the-social-media">Link all the social media!</h2><p>Adding share buttons for social media services seems like a no-brainer today. I was already exploring <a href="https://www.addtoany.com/">AddToAny</a> service to add such buttons to my site, but then I decided to do a little bit of background research and think about the effects of such buttons.</p><p>A quick search returns articles that suggest avoiding social media share buttons (<a href="http://solomon.io/why-im-done-with-social-media-buttons/">1</a>, <a href="http://exisweb.net/truth-about-share-buttons">2</a>, <a href="http://scottwhyoung.com/social-media/measuring-value-of-social-media-buttons/">3</a>) and question their actual value for the website. I checked that AddToAny creates 3 extra requests on a page load. Although such requests are probably cached in the desktop browser, mobile browsers don’t necessarily have such luck with caching and they will then suffer quite a large extra delay while loading those resources.</p><p>Also the share buttons would needlessly clutter my otherwise minimalistic layout, even if I’m not a graphically talented designer to give a professional opinion about this. And also I have had horrible experiences browsing web on a phone where these kinds of social media sharing buttons actually take real estate on the screen and contribute more to already slow mobile experience.</p><p>These things taken into account, I won’t be adding social media sharing buttons here, as their downsides seem to be bigger than the upsides.</p><h2 id="adding-metadata">Adding metadata</h2><p>Adding metadata to pages should make it more easy to share these articles around, as different services are able to bring out the relevant content on those pages. Major metadata collections for blog posts used all over the web <a href="http://www.iacquire.com/blog/18-meta-tags-every-webpage-should-have-in-2013">seem to be</a> Facebook’s <a href="https://developers.facebook.com/docs/sharing/opengraph/using-objects">Open Graph objects</a>, <a href="https://dev.twitter.com/cards/overview">Twitter Cards</a>, and <a href="https://developers.google.com/structured-data/rich-snippets/articles">Rich Snippets for Articles</a> that Google uses. To use all of these, you need to have the following information available:</p><ul><li>Information about the author:<ul><li>Name</li><li>Web page</li><li>Twitter handle</li></ul></li><li>Information about the organization that produces this content:<ul><li>Name</li><li>Logo</li><li>Twitter handle</li></ul></li><li>Information about the article:<ul><li>Title</li><li>Publishing date</li><li>Modified date</li><li>Unique per article image, different sizes</li><li>Article URL</li><li>Description/excerpt</li><li>Tags/keywords</li></ul></li></ul><p>Not all of this information is used in all metadata collections, but you need to have that much data available if you want to use all these three services. Fortunately these services provide metadata validators:</p><ul><li><a href="https://developers.facebook.com/tools/debug/og/object/">Open Graph Object Debugger</a></li><li><a href="https://cards-dev.twitter.com/validator">Twitter Card Validator</a></li><li><a href="https://developers.google.com/structured-data/testing-tool/">Structured Data Testing Tool</a></li></ul><h3 id="unique-article-images">Unique article images</h3><p>The thing that resulted in the most issues was to get an unique per article image done. That might make sense for news articles, but when there are software development related articles about abstract matters, it’s pretty hard to come up with images that do not look out of place or are just completely made up. So I decided to completely make up images that are generated automatically, if there is nothing better specified.</p><p>I’m using identicon type of approach by creating such 4 icons from <a href="https://en.wikipedia.org/wiki/SHA-1">SHA-1</a> of article’s path (“/2016/01/software-development-blog” for this one). Then these icons are either combined horizontally or to a 2x2 square grid and that way they are used to create article images that are appropriate for different media. It’s a crude trick, but at least with a very high probability it generates a unique per article image that can be visually identified. For example this article has these identifier images:</p><figure><p><img src="https://barro.github.io/2016/01/software-development-blog/id-square-400x400.png" alt="400x400 square identicon for this article" width="400px" height="400px"/></p> <figcaption>400x400 square identicon for this article.</figcaption> </figure><figure><p><img src="https://barro.github.io/2016/01/software-development-blog/id-large-800x200.png" alt="800x200 horizontal identicon for this article" width="800px" height="200px"/></p> <figcaption>800x200 horizontal identicon for this article.</figcaption> </figure><h2 id="monetizing-blogging">Monetizing blogging</h2><p>There are various ways how one can monetize blogging, of which ads are usually the most visible one. As I’m just starting and I don’t have any established readership, it would be a waste of my time to add any advertisements on these pages. If I get to 1000 readers monthly, then I will probably add some very lightweight ads, as that way I could use the money for one extra chocolate bar per month.</p><h2 id="how-timeless-is-this">How timeless is this?</h2><p>Probably in 5 years, I have lost interest in blogging. Most of the pages that I’m now linking into are gone. Many of the subjects will be outdated either by technology going forwards or development methods going forward. Jekyll will be either in maintenance mode or a completely abandoned project. If I continue blogging, I might even have started using some real blogging service or some other blogging platform.</p><h2 id="conclusion">Conclusion</h2><p>I have not actively been involved in web development during the last couple of years and this provided me an excellent opportunity to see that what kind of web development related advances and changes there have been. The biggest surprise comes from the metadata usage, and how many different systems expect to have icons in different sizes and formats.</p><p>I generally try to put usability and speed before looking fancy. In this blog, however the need for speed is not always satisfied, as having the commenting system hosted outside adds a lot of extra data to transfer and makes these pages more heavy for low power devices.</p></li></ul><div class="previous-next-pages"> Page 2/2 • <a href="/">Newer articles</a></div><p class="rss-subscribe">subscribe <a href="https://feeds.feedburner.com/jussijudin">via RSS</a></p></div></div></div><footer class="site-footer"><div class="wrapper"><h2 class="footer-heading">Jussi Judin's weblog</h2><div class="footer-col-wrapper"><div class="footer-col footer-col-1"><ul class="contact-list"><li>Jussi Judin</li><li>jju<span>din</span>+github <span>AT</span> iki DOT <span>f</span>i</li></ul></div><div class="footer-col footer-col-2"><ul class="social-media-list"><li> <a href="https://github.com/barro" title="Barro">GitHub</a></li><li> <a href="https://bitbucket.org/barro" title="barro">Bitbucket</a></li><li> <a href="https://facebook.com/b4rr0" title="B4rr0">Facebook</a></li><li> <a href="https://twitter.com/B4rr0" title="@B4rr0">Twitter</a></li><li> <a href="https://plus.google.com/+JussiJudin-jj/" title="+JussiJudin-jj">Google+</a></li></ul></div><div class="footer-col footer-col-3"><p>Programming related topics. Maybe even some original content!</p></div></div></div></footer><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-71880517-1","auto"),ga("send","pageview")</script></body></html>