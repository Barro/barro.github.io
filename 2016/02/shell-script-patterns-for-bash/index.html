<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Shell script patterns for bash</title><meta name="description" content="Useful patterns for shell scripting that make your scripts more robust."/><link rel="stylesheet" href="/css/main.css"/><link rel="canonical" href="https://barro.github.io/2016/02/shell-script-patterns-for-bash/"/><link rel="alternate" type="application/rss+xml" title="Jussi Judin's weblog" href="https://feeds.feedburner.com/jussijudin"/><link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png"/><link rel="icon" type="image/png" href="/icons/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/icons/android-chrome-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/icons/favicon-96x96.png" sizes="96x96"/><link rel="icon" type="image/png" href="/icons/favicon-16x16.png" sizes="16x16"/><link rel="manifest" href="/icons/manifest.json"/><link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#00a300"/><meta name="msapplication-TileImage" content="/icons/mstile-144x144.png"/><meta name="theme-color" content="#ffffff"/><meta content="928229747232422" property="fb:app_id"/><meta content="Jussi Judin's weblog" property="og:site_name"/><meta content="Shell script patterns for bash" property="og:title"/><meta content="article" property="og:type"/><meta content="Useful patterns for shell scripting that make your scripts more robust." property="og:description"/><meta content="https://barro.github.io/2016/02/shell-script-patterns-for-bash/" property="og:url"/><meta content="2016-02-14T18:00:03+02:00" property="article:published_time"/><meta content="https://barro.github.io/author/" property="article:author"/><meta property="og:image" content="https://barro.github.io/2016/02/shell-script-patterns-for-bash/id-cropped-800x400.png"/><meta content="bash" property="article:tag"/><meta content="shell-scripts" property="article:tag"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@b4rr0"/><meta name="twitter:creator" content="@b4rr0"/><meta name="twitter:title" content="Shell script patterns for bash"/><meta name="twitter:url" content="https://barro.github.io/2016/02/shell-script-patterns-for-bash/"/><meta name="twitter:description" content="Useful patterns for shell scripting that make your scripts more robust."/><meta name="twitter:image:src" content="https://barro.github.io/2016/02/shell-script-patterns-for-bash/id-square-400x400.png"/></head><body><header class="site-header"><div class="wrapper"><a class="site-title" href="/">Jussi Judin's weblog</a><nav class="site-nav"> <a href="#" class="menu-icon"> <svg viewBox="0 0 18 15"> <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/> <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/> <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/> </svg> </a><div class="trigger"> <a class="page-link" href="/archive/">Archive</a> <a class="page-link" href="/author/">Author</a> <a class="page-link" href="https://feeds.feedburner.com/jussijudin">RSS</a></div> </nav></div></header><div class="page-content"><div class="wrapper"><article class="post" itemscope="itemscope" itemtype="http://schema.org/BlogPosting"><meta itemprop="keywords" content="bash,shell-scripts"/> <span itemprop="publisher" itemscope="itemscope" itemtype="https://schema.org/Organization"> <span itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://barro.github.io/icons/parruki-60x60.png"/><meta itemprop="width" content="60"/><meta itemprop="height" content="60"/> </span><meta itemprop="name" content="ParruKi blog"/> </span><meta itemprop="description" content="Useful patterns for shell scripting that make your scripts more robust."/><meta itemscope="itemscope" itemprop="mainEntityOfPage" itemType="https://schema.org/WebPage" itemid="https://barro.github.io/2016/02/shell-script-patterns-for-bash/"/> <header class="post-header"><h1 class="post-title" itemprop="name headline">Shell script patterns for bash</h1><p class="post-meta"><time datetime="2016-02-14T18:00:03+02:00" itemprop="datePublished dateModified">Sunday, Feb 14, 2016</time> • <span itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"> <span itemprop="name">Jussi Judin</span> </span> • <a itemprop="image" itemscope="itemscope" itemtype="https://schema.org/ImageObject" href="https://barro.github.io/2016/02/shell-script-patterns-for-bash/id-cropped-800x400.png"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMBAMAAADWlCNiAAAAD1BMVEUAAAAHWQQvMbZ/JitKvvFoMy33AAAAAXRSTlMAQObYZgAAAEJJREFUeAFjYGAUFBRgUFJgYGBSMgYDFwcGBhYXMiSAokA5BghgNjY2AIkC5ciRAAMGBCBTAmEHkxLQxVDnggHpEgAkahpNd1SakQAAAABJRU5ErkJggg==" title="Article identicon" alt="Article identicon" width="48" height="12"/><meta itemprop="url" content="https://barro.github.io/2016/02/shell-script-patterns-for-bash/id-cropped-800x400.png"/><meta itemprop="width" content="800"/><meta itemprop="height" content="400"/> </a></p> </header><div class="post-content" itemprop="articleBody"><p>I write a lot of shell scripts using bash to glue together existing programs and their data. I have noticed that some patterns have emerged that I very often use when writing these scripts nowadays. Let the following script to demonstrate:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="nb">set</span> <span class="nt">-u</span>  <span class="c"># Exit if undefined variable is used.</span>
<span class="nb">set</span> <span class="nt">-e</span>  <span class="c"># Exit after first command failure.</span>
<span class="nb">set</span> <span class="nt">-o</span> pipefail  <span class="c"># Exit if any part of the pipe fails.</span>

<span class="nv">ITERATIONS</span><span class="o">=</span><span class="nv">$1</span>  <span class="c"># Notice that there are no quotes here.</span>
<span class="nb">shift
</span><span class="nv">COMMAND</span><span class="o">=(</span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span><span class="o">)</span>  <span class="c"># Create arrays from commands.</span>

<span class="nv">DIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">"</span><span class="k">$(</span>readlink <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span><span class="k">)</span>  <span class="c"># Get the script directory.</span>
<span class="nb">echo</span> <span class="s2">"Running '</span><span class="k">${</span><span class="nv">COMMAND</span><span class="p">[*]</span><span class="k">}</span><span class="s2">' in </span><span class="nv">$DIR</span><span class="s2"> for </span><span class="nv">$ITERATIONS</span><span class="s2"> iterations"</span>

<span class="nv">WORKDIR</span><span class="o">=</span><span class="k">$(</span>mktemp <span class="nt">--directory</span><span class="k">)</span>
<span class="k">function </span>cleanup<span class="o">()</span>
<span class="o">{</span>
    rm <span class="nt">-rf</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span>
<span class="o">}</span>
<span class="nb">trap </span>cleanup EXIT  <span class="c"># Make sure that we clean up in any situation.</span>

<span class="k">for </span>_ <span class="k">in</span> <span class="k">$(</span>seq 1 <span class="s2">"</span><span class="nv">$ITERATIONS</span><span class="s2">"</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    <span class="o">(</span>  <span class="c"># Avoid the effect of "cd" command from propagating.</span>
        <span class="nb">cd</span> <span class="s2">"</span><span class="nv">$WORKDIR</span><span class="s2">"</span>
        <span class="s2">"</span><span class="k">${</span><span class="nv">COMMAND</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span> <span class="se">\ </span> <span class="c"># Execute command from an array.</span>
            | <span class="nb">cat</span>
    <span class="o">)</span>
<span class="k">done</span></code></pre></figure><h2 id="fail-fast-in-case-of-errors">Fail fast in case of errors</h2><p>Lines <code class="highlighter-rouge">3</code>–<code class="highlighter-rouge">5</code> are related to handling erroneous situations. If any of the situations happen that these settings have effect on, they will exit the shell script and prevent it running further. They can be combined to <code class="highlighter-rouge">set -ueo pipefail</code> as a shorthand notation.</p><p>A very common mistake is to have an undefined variable, by just forgetting to set the value, or mistyping a variable name. <code class="highlighter-rouge">set -u</code> at line <code class="highlighter-rouge">3</code>prevents these kind of issues from happening. Other very common situation in shell scripts is that some program is used incorrectly, it fails, and then rest of the shell script just continues execution. This then causes hard to notice failures later on. <code class="highlighter-rouge">set -e</code> at line <code class="highlighter-rouge">4</code> prevents these issues from happening. And because life is not easy in bash, we need to ensure that such program execution failures that are part of pipelines are also caught. This is done by <code class="highlighter-rouge">set -o pipefail</code> on line <code class="highlighter-rouge">5</code>.</p><h2 id="clean-up-after-yourself-even-in-unexpected-situations">Clean up after yourself even in unexpected situations</h2><p>It’s always a good idea to use unique temporary files or directories for anything that can be created during runtime that is not a specific target of the script. This makes sure that even if many instances of the script are executed in parallel, there won’t be any race condition issues. <code class="highlighter-rouge">mktemp</code> command on line <code class="highlighter-rouge">14</code> shows how to create such temporary files.</p><p>Creating temporary files and directories poses a problem where they may not be deleted if the script is exited too early or if you forget to do a manual cleanup. <code class="highlighter-rouge">cleanup()</code> function shown at lines <code class="highlighter-rouge">15</code>–<code class="highlighter-rouge">18</code> includes code that makes sure that the script cleans up after itself and <code class="highlighter-rouge">trap cleanup EXIT</code> makes sure that <code class="highlighter-rouge">cleanup()</code> is implicitly called in any situation where this script may exit.</p><h2 id="executing-commands">Executing commands</h2><p>Something that is often seen in shell scripts that when you need to create a variable that has a command with arguments, you then execute the variable as it is (<code class="highlighter-rouge">$COMMAND</code>) without using any safety mechanisms against <a href="http://www.golemtechnologies.com/articles/shell-injection">input that can lead into unexpected results in the shell script</a>. Lines <code class="highlighter-rouge">9</code> <code class="highlighter-rouge">COMMAND=("$@")</code> and <code class="highlighter-rouge">24</code> <code class="highlighter-rouge">"${COMMAND[@]}"</code> show a way to assign a command into an array and run such array as command and its parameters. Line <code class="highlighter-rouge">25</code> then includes a pipe just to demonstrate that <code class="highlighter-rouge">set -o pipefail</code> works if you pass a command that fails.</p><h2 id="script-directory-reference">Script directory reference</h2><p>Sometimes it’s very useful to access other files in the same directory where the executed shell script resides in. Line <code class="highlighter-rouge">11</code> <code class="highlighter-rouge">DIR=$(dirname "$(readlink -f "$0")")</code> basically gives the absolute path to the current shell script directory. The order of <code class="highlighter-rouge">readlink</code> and <code class="highlighter-rouge">dirname</code> commands can be changed depending if you want to access the directory where the command to execute this script points to or where the script actually resides in. These can be different locations if there is a symbolic link to the script. The order shown above points to the directory where the script is physically located at.</p><h2 id="quotes-are-not-always-needed">Quotes are not always needed</h2><p>Normally in bash if you reference variables without enclosing them into quotes, you risk of shell injection attacks. But when assigning variables in bash, you don’t need to have quotes in the assignment as long as you don’t use spaces. The same applies to <a href="https://www.gnu.org/software/bash/manual/html_node/Command-Substitution.html">command substitution</a> (<a href="https://google.github.io/styleguide/shell.xml?showone=Use_Local_Variables#Use_Local_Variables">some caveats with variable declarations apply</a>). This style is demonstrated on lines <code class="highlighter-rouge">7</code> <code class="highlighter-rouge">ITERATIONS=$1</code>and <code class="highlighter-rouge">11</code> <code class="highlighter-rouge">DIR=$(...)</code>.</p><h2 id="shellcheck-your-scripts">Shellcheck your scripts</h2><p>One cool program that will make you a better shell script writer is <a href="http://www.shellcheck.net/">ShellCheck</a>. It basically has a list of issues in shell scripts that it detects and can notify you whenever it notices issues that should be fixed. If you are writing shell scripts as part of some version controlled project, you should add an automatic ShellCheck verification step for all shell scripts that you put into your repository.</p></div></article><div id="disqus_thread"></div> <script>var disqus_config=function(){this.page.url="https://barro.github.io/2016/02/shell-script-patterns-for-bash/",this.page.identifier="/2016/02/shell-script-patterns-for-bash"};!function(){var t=document,e=t.createElement("script");e.src="//barro.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script></div></div><footer class="site-footer"><div class="wrapper"><h2 class="footer-heading">Jussi Judin's weblog</h2><div class="footer-col-wrapper"><div class="footer-col footer-col-1"><ul class="contact-list"><li>Jussi Judin</li><li>jju<span>din</span>+github <span>AT</span> iki DOT <span>f</span>i</li></ul></div><div class="footer-col footer-col-2"><ul class="social-media-list"><li> <a href="https://github.com/barro" title="Barro">GitHub</a></li><li> <a href="https://bitbucket.org/barro" title="barro">Bitbucket</a></li><li> <a href="https://facebook.com/b4rr0" title="B4rr0">Facebook</a></li><li> <a href="https://twitter.com/B4rr0" title="@B4rr0">Twitter</a></li><li> <a href="https://plus.google.com/+JussiJudin-jj/" title="+JussiJudin-jj">Google+</a></li></ul></div><div class="footer-col footer-col-3"><p>Programming related topics. Maybe even some original content!</p></div></div></div></footer><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-71880517-1","auto"),ga("send","pageview")</script></body></html>