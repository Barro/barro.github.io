<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>C, for(), and signed integer overflow</title><meta name="description" content="Undefined behavior in C can lead into interesting results with different compilers and compilation options."/><link rel="stylesheet" href="/css/main.css"/><link rel="canonical" href="https://barro.github.io/2016/02/c-for-and-signed-integer-overflow/"/><link rel="alternate" type="application/rss+xml" title="Jussi Judin's weblog" href="https://feeds.feedburner.com/jussijudin"/><link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png"/><link rel="icon" type="image/png" href="/icons/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/icons/android-chrome-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/icons/favicon-96x96.png" sizes="96x96"/><link rel="icon" type="image/png" href="/icons/favicon-16x16.png" sizes="16x16"/><link rel="manifest" href="/icons/manifest.json"/><link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#00a300"/><meta name="msapplication-TileImage" content="/icons/mstile-144x144.png"/><meta name="theme-color" content="#ffffff"/><meta content="928229747232422" property="fb:app_id"/><meta content="Jussi Judin's weblog" property="og:site_name"/><meta content="C, for(), and signed integer overflow" property="og:title"/><meta content="article" property="og:type"/><meta content="Undefined behavior in C can lead into interesting results with different compilers and compilation options." property="og:description"/><meta content="https://barro.github.io/2016/02/c-for-and-signed-integer-overflow/" property="og:url"/><meta content="2016-02-21T18:00:04+02:00" property="article:published_time"/><meta content="https://barro.github.io/author/" property="article:author"/><meta property="og:image" content="https://barro.github.io/2016/02/c-for-and-signed-integer-overflow/id-cropped-800x400.png"/><meta content="c/c++" property="article:tag"/><meta content="undefined-behavior" property="article:tag"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@b4rr0"/><meta name="twitter:creator" content="@b4rr0"/><meta name="twitter:title" content="C, for(), and signed integer overflow"/><meta name="twitter:url" content="https://barro.github.io/2016/02/c-for-and-signed-integer-overflow/"/><meta name="twitter:description" content="Undefined behavior in C can lead into interesting results with different compilers and compilation options."/><meta name="twitter:image:src" content="https://barro.github.io/2016/02/c-for-and-signed-integer-overflow/id-square-400x400.png"/></head><body><header class="site-header"><div class="wrapper"><a class="site-title" href="/">Jussi Judin's weblog</a><nav class="site-nav"> <a href="#" class="menu-icon"> <svg viewBox="0 0 18 15"> <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/> <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/> <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/> </svg> </a><div class="trigger"> <a class="page-link" href="/archive/">Archive</a> <a class="page-link" href="/author/">Author</a> <a class="page-link" href="https://feeds.feedburner.com/jussijudin">RSS</a></div> </nav></div></header><div class="page-content"><div class="wrapper"><article class="post" itemscope="itemscope" itemtype="http://schema.org/BlogPosting"><meta itemprop="keywords" content="c/c++,undefined-behavior"/> <span itemprop="publisher" itemscope="itemscope" itemtype="https://schema.org/Organization"> <span itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://barro.github.io/icons/parruki-60x60.png"/><meta itemprop="width" content="60"/><meta itemprop="height" content="60"/> </span><meta itemprop="name" content="ParruKi blog"/> </span><meta itemprop="description" content="Undefined behavior in C can lead into interesting results with different compilers and compilation options."/><meta itemscope="itemscope" itemprop="mainEntityOfPage" itemType="https://schema.org/WebPage" itemid="https://barro.github.io/2016/02/c-for-and-signed-integer-overflow/"/> <header class="post-header"><h1 class="post-title" itemprop="name headline">C, for(), and signed integer overflow</h1><p class="post-meta"><time datetime="2016-02-21T18:00:04+02:00" itemprop="datePublished dateModified">Sunday, Feb 21, 2016</time> • <span itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"> <span itemprop="name">Jussi Judin</span> </span> • <a itemprop="image" itemscope="itemscope" itemtype="https://schema.org/ImageObject" href="https://barro.github.io/2016/02/c-for-and-signed-integer-overflow/id-cropped-800x400.png"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAIAAACr2KkGAAAABnRSTlMAAAAAAABupgeRAAAAV0lEQVR4AWOYwT6PIDpheZkgYiAFVObcQ0NwKVwOGnUQeYAYdwSkLEdDcCk81pPhslEHYSYdTHfgcSIeB5GVhkYdRDjbY2ojKdvjsR4uRUwaIuSgUQcBAHTD5rL/VRGmAAAAAElFTkSuQmCC" title="Article identicon" alt="Article identicon" width="48" height="12"/><meta itemprop="url" content="https://barro.github.io/2016/02/c-for-and-signed-integer-overflow/id-cropped-800x400.png"/><meta itemprop="width" content="800"/><meta itemprop="height" content="400"/> </a></p> </header><div class="post-content" itemprop="articleBody"><p>Signed integer overflow is <a href="https://en.wikipedia.org/wiki/Undefined_behavior">undefined behavior</a> in C language. This enables compilers to do all kinds of <a href="http://blog.llvm.org/2011/05/what-every-c-programmer-should-know.html">optimization tricks</a> that can lead to surprising and unexpected behavior between different compilers, compiler versions, and optimization levels.</p><p>I encountered something interesting when I tried different versions of <a href="https://gcc.gnu.org/">GCC</a> and <a href="http://clang.llvm.org/">clang</a> with following piece of code:</p><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;limits.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">INT_MAX</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">iterations</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">iterations</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><p>When compiling this with GCC 4.7, GCC 4.9, and clang 3.4 and compilation options for x86_64 architecture, we get following output variations:</p><figure><pre><code>$ gcc-4.9 --std=c11 -O0 tst.c &amp;&amp; ./a.out</code>
3
$ gcc-4.9 --std=c11 -O3 tst.c &amp;&amp; ./a.out
2
$ clang-3.4 --std=c11 -O3 tst.c &amp;&amp; ./a.out
4
$ gcc-4.7 --std=c11 -O3 tst.c &amp;&amp; ./a.out asdf
&lt;infinite loop...&gt;&lt;/code&gt;</pre></figure><p>So let’s analyze these results. The loop <code class="highlighter-rouge">for (int i = INT_MAX - 2; i &gt; 0; i++) {</code> should only iterate <code class="highlighter-rouge">3</code> times until variable <code class="highlighter-rouge">i</code> wraps around to negative value due to <a href="https://en.wikipedia.org/wiki/Two%27s_complement">two’s complement arithmetic</a>. Therefore we would expect <code class="highlighter-rouge">iterations</code> variable to be <code class="highlighter-rouge">3</code>. But this only happens when optimizations are turned off. So let’s see why these outputs result in these different values. Is there some clever loop unrolling that completely breaks here or what?</p><h2 id="gcc-49--o0">GCC 4.9 -O0</h2><p>There is nothing really interesting going in the assembly code produced by GCC without optimizations. It looks like what you would expect from this kind of loop <code class="highlighter-rouge">for()</code> on the lower level. So the main interest is in optimizations that different compilers do.</p><h2 id="gcc-49--o3-andclang-34--o3">GCC 4.9 -O3 and clang 3.4 -O3</h2><p>GCC 4.9 and clang 3.4 both seem to result in similar machine code. They both optimize the <code class="highlighter-rouge">for()</code> loop out and replace the result of it with a (different) constant. GCC 4.9 is just creating code that assigns value <code class="highlighter-rouge">2</code> to the second parameter for <code class="highlighter-rouge">printf()</code> function (see <a href="http://www.x86-64.org/documentation/abi.pdf">System V Application Binary Interface AMD64 Architecture Processor Supplement</a> section 3.2.3 about parameter passing). Similarly clang 3.4 assigns value <code class="highlighter-rouge">4</code> to the second parameter for <code class="highlighter-rouge">printf()</code>.</p><h3 id="gcc-49--o3-assembler-code-for-main">GCC 4.9 -O3 assembler code for main()</h3><p>Here we can see how value <code class="highlighter-rouge">2</code> gets passed as <code class="highlighter-rouge">iterations</code> variable:</p><figure><pre><code>Dump of assembler code for function main:
5 {
0x00000000004003f0 &lt;+0&gt;: sub $0x8,%rsp

6     int iterations = 0;
7     for (int i = INT_MAX - 2; i &gt; 0; i++) {
8         iterations++;
9     }
10     printf("%d\n", <strong>iterations</strong>);
<strong>0x00000000004003f4 &lt;+4&gt;: mov $0x2,%esi</strong>
0x00000000004003f9 &lt;+9&gt;: mov $0x400594,%edi
0x00000000004003fe &lt;+14&gt;: xor %eax,%eax
0x0000000000400400 &lt;+16&gt;: callq 0x4003c0 &lt;printf@plt&gt;

11     return 0;
12 }
0x0000000000400405 &lt;+21&gt;: xor %eax,%eax
0x0000000000400407 &lt;+23&gt;: add $0x8,%rsp
0x000000000040040b &lt;+27&gt;: retq
</code></pre></figure><h3 id="clang-34--o3-assembler-code-for-main">clang 3.4 -O3 assembler code for main()</h3><p>Here we can see how value <code class="highlighter-rouge">4</code> gets passed as <code class="highlighter-rouge">iterations</code> variable:</p><figure><pre><code>Dump of assembler code for function main:
5 {

6     int iterations = 0;
7     for (int i = INT_MAX - 2; i &gt; 0; i++) {
8         iterations++;
9     }
10     printf("%d\n", <strong>iterations</strong>);
0x00000000004004e0 &lt;+0&gt;: push %rax
0x00000000004004e1 &lt;+1&gt;: mov $0x400584,%edi
<strong>0x00000000004004e6 &lt;+6&gt;: mov $0x4,%esi</strong>
0x00000000004004eb &lt;+11&gt;: xor %eax,%eax
0x00000000004004ed &lt;+13&gt;: callq 0x4003b0 &lt;printf@plt&gt;
0x00000000004004f2 &lt;+18&gt;: xor %eax,%eax

11     return 0;
0x00000000004004f4 &lt;+20&gt;: pop %rdx
0x00000000004004f5 &lt;+21&gt;: retq
</code></pre></figure><h2 id="gcc-47--o3">GCC 4.7 -O3</h2><p>GCC 4.7 has an interesting result from optimizer that is completely different that could be expected to happen. It basically replaces <code class="highlighter-rouge">main()</code> function with just one instruction that does nothing else than jumps at the same address that it resides in and thus creates an infinite loop:</p><figure><pre><code>Dump of assembler code for function main:
5 {
0x0000000000<strong>400400</strong> &lt;+0&gt;: jmp <strong>0x400400</strong> &lt;main&gt;
</code></pre></figure><h2 id="conclusion">Conclusion</h2><p>This is an excellent example of <a href="http://www.catb.org/jargon/html/N/nasal-demons.html">nasal demons</a> happening when there is undefined behavior ongoing and compilers have free hands to do anything they want. Especially as GCC 4.7 produces really harmful machine code that instead of producing unexpected value as a result, it just makes the program unusable. Other compilers and other architectures could result in different behavior, but let that be something for the future investigation.</p></div></article><div id="disqus_thread"></div> <script>var disqus_config=function(){this.page.url="https://barro.github.io/2016/02/c-for-and-signed-integer-overflow/",this.page.identifier="/2016/02/c-for-and-signed-integer-overflow"};!function(){var e=document,t=e.createElement("script");t.src="//barro.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}()</script></div></div><footer class="site-footer"><div class="wrapper"><h2 class="footer-heading">Jussi Judin's weblog</h2><div class="footer-col-wrapper"><div class="footer-col footer-col-1"><ul class="contact-list"><li>Jussi Judin</li><li>jju<span>din</span>+github <span>AT</span> iki DOT <span>f</span>i</li></ul></div><div class="footer-col footer-col-2"><ul class="social-media-list"><li> <a href="https://github.com/barro" title="Barro">GitHub</a></li><li> <a href="https://bitbucket.org/barro" title="barro">Bitbucket</a></li><li> <a href="https://facebook.com/b4rr0" title="B4rr0">Facebook</a></li><li> <a href="https://twitter.com/B4rr0" title="@B4rr0">Twitter</a></li><li> <a href="https://plus.google.com/+JussiJudin-jj/" title="+JussiJudin-jj">Google+</a></li></ul></div><div class="footer-col footer-col-3"><p>Programming related topics. Maybe even some original content!</p></div></div></div></footer><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-71880517-1","auto"),ga("send","pageview")</script></body></html>